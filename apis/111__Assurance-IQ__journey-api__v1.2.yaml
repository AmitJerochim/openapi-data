openapi: 3.0.0
info:
  version: "v1.2"
  title: 'Journey API'
  description: 'A public API that allows Assurance partners to report application- and policy- related events to Assurance'

servers:
  - description: Assurance Staging Environment
    url: https://staging.assurance.com
  - description: Assurance Production Environment
    url: https://assurance.com

security:
  - oauth2-staging: []
  - oauth2-production: []

paths:
  /ei/v1/journeys/{journey_id}/events:
    post:
      operationId: create-journey-event
      security:
        - oauth2-staging: [write_journey_events]
        - oauth2-production: [write_journey_events]
      parameters:
        - name: journey_id
          description: An unique Journey identifier generated by Assurance
          required: true
          in: path
          schema:
            $ref: '#/components/schemas/JourneyId'
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateJourneyEventRequest'
      responses:
        '201':
          description: '201: Event was created successfully'
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateJourneyEventResponse'
        '400':
          description: '400: Bad request'
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: '401: Authorization information is missing or invalid'
        '403':
          description: '403: The client is not authorized to perform this operation'
        '404':
          description: '404: Journey is not found'
        '5XX':
          description: '5xx: Unexpected error'
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  schemas:
    # Scalar data types
    JourneyId:
      description: An unique Journey identifier generated by Assurance
      type: string
      example: '996bad97-7123-40f4-ae01-e7753fe8a890'

    EventId:
      description: An unique identifier of an event generated by Assurance
      type: string
      example: '5af8a811-8e50-413a-8534-b29e4ce1af03'

    CallerEventId:
      description: An unique identifier of an event provided by the caller
      type: string
      example: 'CC-6987135'

    EventType:
      description: Type of event reported to Assurance
      type: string
      enum:
        - application_status
        - billing_plan_changed
        - documents_available
        - payment
        - policy_status
        - underwriting_decision
        - underwriting_required
        - user_account_status

    ApplicationId:
      description: An unique identifier of an application (case) generated by the caller
      type: string
      example: 'A123456'

    PolicyId:
      description: An unique identifier of a policy generated by the caller
      type: string
      example: 'P321654'

    PaymentId:
      description: An unique identifier of a payment generated by the caller
      type: string
      example: '$$76587'

    ApplicationStatus:
      description: Status of the application
      type: string
      enum:
        - new
        - declined
        - cancelled
        - closed
        - not_taken
        - issued
        - active

    PolicyStatus:
      description: Status of the policy
      type: string
      enum:
        - active
        - cancelled
        - cancelled_free_look
        - surrendered
        - claimed
        - lapsed
        - lapsed_pending
        - expired

    RequirementStatus:
      description: Requirement status
      type: string
      enum:
        - ordered
        - needs_review
        - cancelled
        - completed

    RequirementName:
      description: Requirement name
      type: string
      enum:
        - exam
        - irp
        - hiv_consent
        - aps
        - misc_client_req

    PaymentMethod:
      description: Payment method
      type: string
      enum:
        - electronic_funds_transfer
        - credit_card

    PaymentType:
      description: Payment type
      type: string
      enum:
        - initial
        - recurring

    UnderwritingDecisionReason:
      description: Underwriting decision reason code
      type: string
      enum:
        - approved
        - approved_modified
        - rejected
        - review_required

    UserAccountStatus:
      description: Status of user account in the carrier system
      type: string
      enum:
        - pending
        - active

    # Event type schemas
    BaseEvent:
      description: Basic information about an event reported to Assurance
      type: object
      properties:
        caller_event_id:
          $ref: '#/components/schemas/CallerEventId'
        caller_event_ts:
          description: Time of the event as reported by the caller
          type: string
          format: date-time
          example: '2020-01-02T03:04:05Z'
        event_type:
          $ref: '#/components/schemas/EventType'
      required:
        - caller_event_id
        - caller_event_ts
        - event_type

    BasePolicyEvent:
      description: Basic information about policy-related event
      allOf:
        - $ref: '#/components/schemas/BaseEvent'
        - type: object
          properties:
            policy_id:
              $ref: '#/components/schemas/PolicyId'
          required:
            - policy_id

    ApplicationStatusEvent:
      description: Application (case) status change event
      allOf:
        - $ref: '#/components/schemas/BaseEvent'
        - type: object
          properties:
            application_id:
              $ref: '#/components/schemas/ApplicationId'
            application_status:
              $ref: '#/components/schemas/ApplicationStatus'
          required:
            - application_id
            - application_status

    UnderwritingRequirementEvent:
      description: Underwriting medical requirement change event
      allOf:
        - $ref: '#/components/schemas/BasePolicyEvent'
        - type: object
          properties:
            requirement_name:
              $ref: '#/components/schemas/RequirementName'
            requirement_status:
              $ref: '#/components/schemas/RequirementStatus'
            requirement_ts:
              description: Requirement status change date & time
              type: string
              format: date-time
              example: '2020-01-03T03:04:05Z'
          required:
            - requirement_name
            - requirement_status
            - requirement_ts

    UnderwritingDecisionEvent:
      description: Underwriting decision event
      allOf:
        - $ref: '#/components/schemas/BasePolicyEvent'
        - type: object
          properties:
            decision_details:
              description: Decision information
              type: string
            decision_reason:
              $ref: '#/components/schemas/UnderwritingDecisionReason'
            premium_amount:
              type: number
              format: float
            modified_premium_amount:
              type: number
              format: float
            max_face_value:
              type: number
              format: float
          required:
            - decision_details

    PaymentEvent:
      description: Payment failure event
      allOf:
        - $ref: '#/components/schemas/BasePolicyEvent'
        - type: object
          properties:
            payment_method:
              $ref: '#/components/schemas/PaymentMethod'
            payment_success:
              type: boolean
            payment_type:
              $ref: '#/components/schemas/PaymentType'
            failure_reason:
              type: string
            payment_id:
              $ref: '#/components/schemas/PaymentId'
          required:
            - payment_method
            - payment_success

    PolicyStatusEvent:
      description: Policy status event
      allOf:
        - $ref: '#/components/schemas/BasePolicyEvent'
        - type: object
          properties:
            policy_status:
              $ref: '#/components/schemas/PolicyStatus'
          required:
            - policy_status

    DocumentsAvailableEvent:
      description: Documents available event
      allOf:
        - $ref: '#/components/schemas/BaseEvent'
        - type: object
          properties:
            application_id:
              $ref: '#/components/schemas/ApplicationId'
            policy_id:
              $ref: '#/components/schemas/PolicyId'
            documents:
              type: array
              minItems: 1
              items:
                type: object
                properties:
                  name:
                    type: string
                  url:
                    type: string
                required:
                  - name
                  - url
          minProperties: 2
          maxProperties: 2
          required:
            - documents

    BillingPlanChangedEvent:
      description: Billing plan changed event
      allOf:
        - $ref: '#/components/schemas/BasePolicyEvent'
        - type: object
          properties:
            payment_method:
              $ref: '#/components/schemas/PaymentMethod'
            draft_day:
              type: integer
            payment_id:
              $ref: '#/components/schemas/PaymentId'
          required:
            - payment_method
            - draft_day

    UserAccountStatusEvent:
      description: User account status event
      allOf:
        - $ref: '#/components/schemas/BasePolicyEvent'
        - type: object
          properties:
            user_account_status:
              $ref: '#/components/schemas/UserAccountStatus'
          required:
            - user_account_status

    # Request/response schemas
    CreateJourneyEventRequest:
      description: A request initiated by caller to report event to Assurance
      type: object
      properties:
        data:
          oneOf:
            - $ref: '#/components/schemas/ApplicationStatusEvent'
            - $ref: '#/components/schemas/UnderwritingRequirementEvent'
            - $ref: '#/components/schemas/UnderwritingDecisionEvent'
            - $ref: '#/components/schemas/PaymentEvent'
            - $ref: '#/components/schemas/PolicyStatusEvent'
            - $ref: '#/components/schemas/DocumentsAvailableEvent'
            - $ref: '#/components/schemas/BillingPlanChangedEvent'
            - $ref: '#/components/schemas/UserAccountStatusEvent'
          discriminator:
            propertyName: event_type
            mapping:
              application_status: '#/components/schemas/ApplicationStatusEvent'
              underwriting_required: '#/components/schemas/UnderwritingRequirementEvent'
              underwriting_decision: '#/components/schemas/UnderwritingDecisionEvent'
              payment: '#/components/schemas/PaymentEvent'
              policy_status: '#/components/schemas/PolicyStatusEvent'
              documents_available: '#/components/schemas/DocumentsAvailableEvent'
              billing_plan_changed: '#/components/schemas/BillingPlanChangedEvent'
              user_account_status: '#/components/schemas/UserAccountStatusEvent'
      example:
        data:
          caller_event_id: 'CC-123'
          caller_event_ts: '2020-01-02T03:04:05Z'
          event_type: 'application_status'
          application_id: 'A098092'
          application_status: 'new'

    CreateJourneyEventResponse:
      description: A response returned by Assurance after successful processing of an event
      type: object
      properties:
        data:
          description: Information about event
          type: object
          properties:
            id:
              $ref: '#/components/schemas/EventId'
            type:
              $ref: '#/components/schemas/EventType'
            attributes:
              description: Additional information about an event, if any
              type: object
              additionalProperties: true
          required:
            - id
            - type

    ErrorResponse:
      description: An error response returned by Assurance
      type: object
      properties:
        errors:
          description: List of all error encountered while processing the request
          type: array
          minItems: 1
          items:
            type: object
            properties:
              title:
                description: A short, human-readable summary of the problem
                type: string
                example: Unsupported event type
              detail:
                description: A human-readable explanation specific to this occurrence of the problem
                type: string
                example: Event type 'some_other_event_type' is not supported
            additionalProperties: true
            required:
              - title
      required:
        - errors

  securitySchemes:
    oauth2-staging:
      type: oauth2
      description: This API uses OAuth2.0 with Client Credentials Grant.
      flows:
        clientCredentials:
          # Auth0 requires "audience" parameter to be passed in the body of the request
          # for Client Credentials authentication. Unfortunately OpenAPI 3 does not [yet] allow
          # customizing the body of the Client Credential request and authentication through Swagger UI
          # won't work.
          tokenUrl: https://assurance-ei-integ.auth0.com/oauth/token?audience=https://staging.assurance.com/ei/
          scopes:
            read_journeys: Grants read access to Journeys
            write_journeys: Grants read access to Journeys
            read_journey_events: Grants read access to Journey Events
            write_journey_events: Grants read access to Journey Events

    oauth2-production:
      type: oauth2
      description: This API uses OAuth2.0 with Client Credentials Grant.
      flows:
        clientCredentials:
          # Auth0 requires "audience" parameter to be passed in the body of the request
          # for Client Credentials authentication. Unfortunately OpenAPI 3 does not [yet] allow
          # customizing the body of the Client Credential request and authentication through Swagger UI
          # won't work.
          tokenUrl: https://assurance-ei.auth0.com/oauth/token?audience=https://assurance.com/ei/
          scopes:
            read_journeys: Grants read access to Journeys
            write_journeys: Grants read access to Journeys
            read_journey_events: Grants read access to Journey Events
            write_journey_events: Grants read access to Journey Events
